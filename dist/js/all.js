class DBHelper{static get DATABASE_URL(){return"http://localhost:1337/"}static get RESTAURANT_URL(){return`${this.DATABASE_URL}restaurants/`}static get REVIEW_URL(){return`${this.DATABASE_URL}reviews/`}static get database(){if(!navigator.serviceWorker)return Promise.resolve();return(window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB||window.shimIndexedDB).open("rreviews",1)}static fetchRestaurants(e){DBHelper.getRestaurantDataFromIndexedDB().then(t=>{e(null,t)}),fetch(DBHelper.RESTAURANT_URL).then(e=>e.json()).then(t=>{DBHelper.storeRestaurantDataInIndexedDB(t),e(null,t)}).catch(t=>{e(t,null)})}static fetchRestaurantById(e,t){const n=`${this.REVIEW_URL}?restaurant_id=${e}`,r=DBHelper.database;DBHelper.upgadeIndexedDB(r),r&&(r.onsuccess=(a=>{const s=r.result;s.transaction(["rreviews"],"readwrite").objectStore("rreviews").index("id").openCursor().onsuccess=(r=>{const a=r.target.result;if(a)if(a.value.id==e){const e=a.value;fetch(n).then(e=>e.json()).then(n=>{e.reviews=n,s.transaction(["rreviews"],"readwrite").objectStore("rreviews").put(e),t(null,e)}).catch(n=>{t(null,e)})}else a.continue()})}))}static storeRestaurantDataInIndexedDB(e){const t=DBHelper.database;DBHelper.upgadeIndexedDB(t),t&&(t.onsuccess=(n=>{const r=t.result.transaction("rreviews","readwrite").objectStore("rreviews");e.forEach(e=>{r.put(e)})}))}static setRestaurantFavorite(e,t){const n=DBHelper.database;DBHelper.upgadeIndexedDB(n),n&&(n.onsuccess=(r=>{const a=n.result.transaction(["rreviews"],"readwrite").objectStore("rreviews").index("id"),s=`${this.RESTAURANT_URL}${e}/?is_favorite=${t}`;a.openCursor().onsuccess=(n=>{const r=n.target.result;if(r)if(r.value.id==e){r.value.is_favorite=t,r.update(r.value);const e=new Request(s,{method:"PUT"});fetch(e).catch(e=>{navigator.onLine||this.addRequestToQueue({url:s,options:{method:"PUT"}})})}else r.continue()})}))}static addRestaurantReview(e){const t=new Request(this.REVIEW_URL,{body:JSON.stringify(e),method:"POST"});fetch(t).then(e=>e.json()).then(t=>{this.fetchRestaurantById(e.restaurant_id,{})}).catch(t=>{navigator.onLine||this.addRequestToQueue({url:this.REVIEW_URL,options:{body:JSON.stringify(e),method:"POST"}}),this.fetchRestaurantById(e.restaurant_id,(t,n)=>{n.reviews.push(e);const r=DBHelper.database;DBHelper.upgadeIndexedDB(r),r&&(r.onsuccess=(e=>{r.result.transaction(["rreviews"],"readwrite").objectStore("rreviews").put(n)}))})})}static getRestaurantDataFromIndexedDB(){return new Promise((e,t)=>{const n=DBHelper.database;DBHelper.upgadeIndexedDB(n),n&&(n.onsuccess=(t=>{const r=[];n.result.transaction("rreviews","readonly").objectStore("rreviews").openCursor().onsuccess=(t=>{const n=t.target.result;n?(r.push(n.value),n.continue()):e(r)})}))})}static upgadeIndexedDB(e){e.onupgradeneeded=function(){const t=e.result,n=t.createObjectStore("rreviews",{keyPath:"id"});n.createIndex("name","name"),n.createIndex("id","id",{unique:!0}),t.createObjectStore("requestqueue",{autoIncrement:!0})}}static fetchRestaurantByCuisine(e,t){DBHelper.fetchRestaurants((n,r)=>{if(n)t(n,null);else{const n=r.filter(t=>t.cuisine_type==e);t(null,n)}})}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchRestaurants((n,r)=>{if(n)t(n,null);else{const n=r.filter(t=>t.neighborhood==e);t(null,n)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,n){DBHelper.fetchRestaurants((r,a)=>{if(r)n(r,null);else{let r=a;"all"!=e&&(r=r.filter(t=>t.cuisine_type==e)),"all"!=t&&(r=r.filter(e=>e.neighborhood==t)),n(null,r)}})}static fetchNeighborhoods(e){DBHelper.fetchRestaurants((t,n)=>{if(t)e(t,null);else{const t=n.map((e,t)=>n[t].neighborhood),r=t.filter((e,n)=>t.indexOf(e)==n);e(null,r)}})}static fetchCuisines(e){DBHelper.fetchRestaurants((t,n)=>{if(t)e(t,null);else{const t=n.map((e,t)=>n[t].cuisine_type),r=t.filter((e,n)=>t.indexOf(e)==n);e(null,r)}})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return`/img/${e.photograph?e.photograph:e.id}`}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}static addRequestToQueue(e){const t=DBHelper.database;DBHelper.upgadeIndexedDB(t),t&&(t.onsuccess=(n=>{t.result.transaction("requestqueue","readwrite").objectStore("requestqueue").put(e)}))}static sendQueuedRequests(){const e=DBHelper.database;DBHelper.upgadeIndexedDB(e),e&&(e.onsuccess=(t=>{e.result.transaction("requestqueue","readwrite").objectStore("requestqueue").openCursor().onsuccess=(e=>{const t=e.target.result;if(t){const e=new Request(t.value.url,t.value.options);fetch(e),t.delete(),t.continue()}})}))}}let map;document.addEventListener("DOMContentLoaded",e=>{fetchNeighborhoods(),fetchCuisines()});const observer=new IntersectionObserver(onIntersection,{rootMargin:"0px",threshold:.1});function onIntersection(e){e.forEach(e=>{e.intersectionRatio>0&&(observer.unobserve(e.target),loadImage(e.target))})}function loadImage(e){const t=e.dataset.src;fetchImage(t).then(()=>{e.src=t})}function fetchImage(e){return new Promise((t,n)=>{const r=new Image;r.src=e,r.onload=t,r.onerror=n})}function fetchNeighborhoods(){DBHelper.fetchNeighborhoods((e,t)=>{e?console.error(e):(this.neighborhoods=t,fillNeighborhoodsHTML())})}function fillNeighborhoodsHTML(e=this.neighborhoods){const t=document.getElementById("neighborhoods-select");t&&e.forEach(e=>{const n=document.createElement("option");n.innerHTML=e,n.value=e,t.appendChild(n)})}function fetchCuisines(){DBHelper.fetchCuisines((e,t)=>{e?console.error(e):(this.cuisines=t,fillCuisinesHTML())})}function fillCuisinesHTML(e=this.cuisines){const t=document.getElementById("cuisines-select");t&&e.forEach(e=>{const n=document.createElement("option");n.innerHTML=e,n.value=e,t.appendChild(n)})}function updateRestaurants(){const e=document.getElementById("cuisines-select"),t=document.getElementById("neighborhoods-select"),n=e.selectedIndex,r=t.selectedIndex,a=e[n].value,s=t[r].value;DBHelper.fetchRestaurantByCuisineAndNeighborhood(a,s,(e,t)=>{e?console.error(e):(resetRestaurants(t),fillRestaurantsHTML())})}function resetRestaurants(e){this.restaurants=[],document.getElementById("restaurants-list").innerHTML="",this.markers&&this.markers.forEach(e=>e.setMap(null)),this.markers=[],this.restaurants=e}function startObserver(){document.querySelectorAll(".restaurant-img").forEach(e=>{observer.observe(e)})}function fillRestaurantsHTML(e=this.restaurants){const t=document.getElementById("restaurants-list");e.forEach(e=>{t.appendChild(createRestaurantHTML(e))}),startObserver(),addMarkersToMap()}function createRestaurantHTML(e){void 0===e.is_favorite&&(e.is_favorite=!1);const t=document.createElement("li");t.className="restaurant-card";const n=document.createElement("picture");n.className="restaurant-picture";const r=document.createElement("source");r.className="source-small";let a=DBHelper.imageUrlForRestaurant(e).concat("-small.jpg"),s=a.replace("small","medium");r.srcset=a+" 1x, "+s+" 2x",n.appendChild(r);const o=document.createElement("source");o.className="source-large";let i=a.replace("small","large");o.srcset=s+" 1x, "+i+" 2x",o.media="(min-width: 750px)",n.appendChild(o);const c=document.createElement("img");c.className="restaurant-img",c.alt='Image of "'+e.name+'" restaurant.',c.setAttribute("data-src",a),n.appendChild(c);const l=document.createElement("div");l.className="restaurant-info-container",l.appendChild(n);const u=document.createElement("h2");u.innerHTML=e.name,l.appendChild(u);const d=document.createElement("a"),m=JSON.parse(e.is_favorite)?"Remove restaurant "+e.name+"from favorites.":"Add restaurant "+e.name+"to favorites.";d.className="tap-target top-right",d.setAttribute("aria-label",m),d.setAttribute("role","button"),d.setAttribute("tabindex","0"),d.setAttribute("data-restid",e.id),d.setAttribute("is-favorite",e.is_favorite),d.addEventListener("click",toggleFavorite,!1),l.appendChild(d);const p=document.createElement("i");p.className="material-icons favorite-icon",p.innerHTML=JSON.parse(e.is_favorite)?"favorite":"favorite_border",d.appendChild(p);const h=document.createElement("div");h.className="address-container";const f=document.createElement("p");f.setAttribute("aria-describedby","restaurant-neighborhood-label"),f.innerHTML=e.neighborhood,h.appendChild(f);const g=document.createElement("p");g.innerHTML=e.address,g.setAttribute("aria-describedby","restaurant-address-label"),h.appendChild(g),l.appendChild(h),t.appendChild(l);const v=document.createElement("a");return v.innerHTML="View Details",v.className="tap-target restaurant-card-details",v.setAttribute("aria-label","Restaurant: "+e.name+": view details."),v.setAttribute("role","button"),v.href=DBHelper.urlForRestaurant(e),t.appendChild(v),t}function addMarkersToMap(e=this.restaurants){e.forEach(e=>{const t=DBHelper.mapMarkerForRestaurant(e,this.map);google.maps.event.addListener(t,"click",()=>{window.location.href=t.url}),this.markers.push(t)})}function toggleFavorite(e){e||(e=window.event);const t=e.srcElement||e.target,n=this.dataset.restid;let r=!JSON.parse(this.getAttribute("is-favorite"));n&&(this.setAttribute("is-favorite",r),DBHelper.setRestaurantFavorite(n,r),t==this?this.childNodes.length>0&&(this.childNodes[0].innerHTML=r?"favorite":"favorite_border"):t.innerHTML=r?"favorite":"favorite_border")}let restaurant;function fetchRestaurantFromURL(e){if(self.restaurant)return void e(null,self.restaurant);const t=getParameterByName("id");t?DBHelper.fetchRestaurantById(t,(t,n)=>{self.restaurant=n,n?(fillRestaurantHTML(),e(null,n)):console.error(t)}):e("No restaurant id in URL",null)}function fillRestaurantHTML(e=self.restaurant){document.getElementById("restaurant-name").innerHTML=e.name,document.getElementById("restaurant-address").innerHTML=e.address;const t=document.getElementById("restaurant-img");t.className="restaurant-img";let n=DBHelper.imageUrlForRestaurant(e).concat("-small.jpg");t.setAttribute("data-src",n),t.alt='Image of "'+e.name+'" restaurant.';const r=document.getElementById("source-small");let a=n.replace("small","medium");r.srcset=n+" 1x, "+a+" 2x";const s=document.getElementById("source-large");let o=n.replace("small","large");s.srcset=a+" 1x, "+o+" 2x",document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type,e.operating_hours&&fillRestaurantHoursHTML(),fillReviewsHTML()}function fillRestaurantHoursHTML(e=self.restaurant.operating_hours){const t=document.getElementById("restaurant-hours");for(let n in e){const r=document.createElement("tr"),a=document.createElement("td");a.innerHTML=n,a.className="table-day",r.appendChild(a);const s=document.createElement("td");s.innerHTML=e[n],s.className="table-time",r.appendChild(s),t.appendChild(r)}}function submitReview(e){e||(e=window.event);const t=(e.srcElement||e.target).getAttribute("restaurant-id"),n=document.getElementById("review-name").value,r=document.getElementById("review-text").value,a=document.getElementById("review-rating").value;if(n&&r){const e={restaurant_id:t,name:n,rating:a,comments:r,createdAt:(new Date).getTime()};document.getElementById("reviews-list").appendChild(createReviewHTML(e));DBHelper.addRestaurantReview(e)}}function fillReviewsHTML(e=self.restaurant.reviews,t=self.restaurant.id){const n=document.getElementById("reviews-container");if(!e){const e=document.createElement("p");return e.innerHTML="No reviews yet!",void n.appendChild(e)}const r=document.getElementById("add-comment");r.setAttribute("restaurant-id",t),r.addEventListener("click",submitReview,!1);const a=document.getElementById("reviews-list");e.forEach(e=>{a.appendChild(createReviewHTML(e))}),n.appendChild(a)}function createReviewHTML(e){const t=document.createElement("li"),n=document.createElement("p");n.innerHTML=e.name,t.appendChild(n);const r=document.createElement("p");r.innerHTML=new Date(e.createdAt).toLocaleDateString(),t.appendChild(r);const a=document.createElement("p");a.innerHTML=`Rating: ${e.rating}`,t.appendChild(a);const s=document.createElement("p");return s.className="review-comments",s.innerHTML=e.comments,t.appendChild(s),t}function fillBreadcrumb(e=self.restaurant){const t=document.getElementById("breadcrumb"),n=document.createElement("li");n.innerHTML=e.name,t.appendChild(n)}function getParameterByName(e,t){t||(t=window.location.href),e=e.replace(/[[\]]/g,"\\$&");const n=new RegExp(`[?&]${e}(=([^&#]*)|&|#|$)`).exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}window.initMap=(()=>{this.map=new google.maps.Map(document.getElementById("map"),{zoom:12,center:{lat:40.722216,lng:-73.987501},scrollwheel:!1}),updateRestaurants()}),window.initMapDetails=(()=>{fetchRestaurantFromURL((e,t)=>{e?console.error(e):(self.map=new google.maps.Map(document.getElementById("map"),{zoom:16,center:t.latlng,scrollwheel:!1}),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.map))})}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("sw.js").then(()=>{console.log("Service Worker Registerd")}).catch(e=>{console.error(e)})}),window.addEventListener("online",DBHelper.sendQueuedRequests,!1);
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJhbGwuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyplc2xpbnQgbm8tdW51c2VkLXZhcnM6IDAqL1xyXG4vKmVzbGludCBuby11bmRlZjogMCovXHJcbi8qZXNsaW50IG5vLWNvbnNvbGU6IDAqL1xyXG4vKmVzbGludCBsaW5lYnJlYWstc3R5bGU6IFtcImVycm9yXCIsIFwid2luZG93c1wiXSovXHJcbi8qKlxyXG4gKiBDb21tb24gZGF0YWJhc2UgaGVscGVyIGZ1bmN0aW9ucy5cclxuICovXHJcbmNsYXNzIERCSGVscGVyIHtcclxuXHQvKipcclxuXHQgKiBEYXRhYmFzZSBVUkwuXHJcblx0ICogQ2hhbmdlIHRoaXMgdG8gcmVzdGF1cmFudHMuanNvbiBmaWxlIGxvY2F0aW9uIG9uIHlvdXIgc2VydmVyLlxyXG5cdCAqL1xyXG5cdHN0YXRpYyBnZXQgREFUQUJBU0VfVVJMKCkge1xyXG5cdFx0Y29uc3QgcG9ydCA9IDEzMzc7IC8vIENoYW5nZSB0aGlzIHRvIHlvdXIgc2VydmVyIHBvcnRcclxuXHRcdHJldHVybiBgaHR0cDovL2xvY2FsaG9zdDoke3BvcnR9L2A7XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgZ2V0IFJFU1RBVVJBTlRfVVJMKCkge1xyXG5cdFx0Y29uc3QgcG9ydCA9IDEzMzc7IC8vIENoYW5nZSB0aGlzIHRvIHlvdXIgc2VydmVyIHBvcnRcclxuXHRcdHJldHVybiBgJHt0aGlzLkRBVEFCQVNFX1VSTH1yZXN0YXVyYW50cy9gO1xyXG5cdH1cclxuXHJcblx0c3RhdGljIGdldCBSRVZJRVdfVVJMKCkge1xyXG5cdFx0Y29uc3QgcG9ydCA9IDEzMzc7IC8vIENoYW5nZSB0aGlzIHRvIHlvdXIgc2VydmVyIHBvcnRcclxuXHRcdHJldHVybiBgJHt0aGlzLkRBVEFCQVNFX1VSTH1yZXZpZXdzL2A7XHJcblx0fVxyXG5cclxuXHJcblx0c3RhdGljIGdldCBkYXRhYmFzZSgpIHtcclxuXHRcdC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBzZXJ2aWNlIHdvcmtlcixcclxuXHRcdC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgaGF2aW5nIGEgZGF0YWJhc2VcclxuXHRcdGlmICghbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIpIHtcclxuXHRcdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG5cdFx0fVxyXG5cdFx0Y29uc3QgaW5kZXhlZERCID0gd2luZG93LmluZGV4ZWREQiB8fCB3aW5kb3cubW96SW5kZXhlZERCIHx8IHdpbmRvdy53ZWJraXRJbmRleGVkREIgfHwgd2luZG93Lm1zSW5kZXhlZERCIHx8IHdpbmRvdy5zaGltSW5kZXhlZERCO1xyXG5cdFx0cmV0dXJuIGluZGV4ZWREQi5vcGVuKCdycmV2aWV3cycsIDEpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogRmV0Y2ggYWxsIHJlc3RhdXJhbnRzLlxyXG5cdCAqL1xyXG5cdHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRzKGNhbGxiYWNrKSB7XHJcblx0XHREQkhlbHBlci5nZXRSZXN0YXVyYW50RGF0YUZyb21JbmRleGVkREIoKS50aGVuKGRhdGEgPT4ge1xyXG5cdFx0XHRjYWxsYmFjayhudWxsLCBkYXRhKTtcclxuXHRcdH0pO1xyXG5cclxuXHRcdGZldGNoKERCSGVscGVyLlJFU1RBVVJBTlRfVVJMKVxyXG5cdFx0XHQudGhlbihyZXNwb25zZSA9PiB7XHJcblx0XHRcdFx0cmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcclxuXHRcdFx0fSlcclxuXHRcdFx0LnRoZW4oZGF0YSA9PiB7XHJcblx0XHRcdFx0Ly9Hb3QgdGhlIGRhdGEsIG5vdyB3cml0dGluZyBpdCBpbiB0aGUgZGF0YWJhc2UuXHJcblx0XHRcdFx0REJIZWxwZXIuc3RvcmVSZXN0YXVyYW50RGF0YUluSW5kZXhlZERCKGRhdGEpO1xyXG5cdFx0XHRcdGNhbGxiYWNrKG51bGwsIGRhdGEpO1xyXG5cdFx0XHR9KVxyXG5cdFx0XHQuY2F0Y2goZXJyb3IgPT4ge1xyXG5cdFx0XHRcdGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuXHRcdFx0fSk7XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlJZChpZCwgY2FsbGJhY2spIHtcclxuXHRcdGNvbnN0IHJldmlld1VSTCA9IGAke3RoaXMuUkVWSUVXX1VSTH0/cmVzdGF1cmFudF9pZD0ke2lkfWA7XHJcblx0XHRjb25zdCBEQk9wZW5SZXF1ZXN0ID0gREJIZWxwZXIuZGF0YWJhc2U7XHJcblx0XHREQkhlbHBlci51cGdhZGVJbmRleGVkREIoREJPcGVuUmVxdWVzdCk7XHJcblx0XHRpZiAoREJPcGVuUmVxdWVzdCkge1xyXG5cdFx0XHREQk9wZW5SZXF1ZXN0Lm9uc3VjY2VzcyA9IChldmVudCkgPT4ge1xyXG5cdFx0XHRcdGNvbnN0IGRiID0gREJPcGVuUmVxdWVzdC5yZXN1bHQ7XHJcblx0XHRcdFx0Y29uc3Qgc3RvcmUgPSBkYi50cmFuc2FjdGlvbihbJ3JyZXZpZXdzJ10sICdyZWFkd3JpdGUnKS5vYmplY3RTdG9yZSgncnJldmlld3MnKTtcclxuXHRcdFx0XHRjb25zdCBpbmRleCA9IHN0b3JlLmluZGV4KCdpZCcpO1xyXG5cclxuXHRcdFx0XHRpbmRleC5vcGVuQ3Vyc29yKCkub25zdWNjZXNzID0gKGV2ZW50KSA9PiB7XHJcblx0XHRcdFx0XHRjb25zdCBjdXJzb3IgPSBldmVudC50YXJnZXQucmVzdWx0O1xyXG5cdFx0XHRcdFx0aWYgKGN1cnNvcikge1xyXG5cdFx0XHRcdFx0XHRpZiAoY3Vyc29yLnZhbHVlLmlkID09IGlkKSB7XHJcblx0XHRcdFx0XHRcdFx0Y29uc3QgcmVzdGF1cmFudCA9IGN1cnNvci52YWx1ZTtcclxuXHRcdFx0XHRcdFx0XHRmZXRjaChyZXZpZXdVUkwpXHJcblx0XHRcdFx0XHRcdFx0XHQudGhlbihyZXNwb25zZSA9PiB7XHJcblx0XHRcdFx0XHRcdFx0XHRcdHJldHVybiByZXNwb25zZS5qc29uKCk7XHJcblx0XHRcdFx0XHRcdFx0XHR9KVxyXG5cdFx0XHRcdFx0XHRcdFx0LnRoZW4oZGF0YSA9PiB7XHJcblx0XHRcdFx0XHRcdFx0XHRcdC8vR290IHRoZSBkYXRhLCBub3cgd3JpdHRpbmcgaXQgaW4gdGhlIGRhdGFiYXNlLlxyXG5cdFx0XHRcdFx0XHRcdFx0XHRyZXN0YXVyYW50LnJldmlld3MgPSBkYXRhO1xyXG5cdFx0XHRcdFx0XHRcdFx0XHRkYi50cmFuc2FjdGlvbihbJ3JyZXZpZXdzJ10sICdyZWFkd3JpdGUnKS5vYmplY3RTdG9yZSgncnJldmlld3MnKS5wdXQocmVzdGF1cmFudCk7XHJcblx0XHRcdFx0XHRcdFx0XHRcdGNhbGxiYWNrKG51bGwsIHJlc3RhdXJhbnQpO1xyXG5cdFx0XHRcdFx0XHRcdFx0fSlcclxuXHRcdFx0XHRcdFx0XHRcdC5jYXRjaChlcnJvciA9PiB7XHJcblx0XHRcdFx0XHRcdFx0XHRcdGNhbGxiYWNrKG51bGwsIHJlc3RhdXJhbnQpO1xyXG5cdFx0XHRcdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHRcdFx0Y3Vyc29yLmNvbnRpbnVlKCk7XHJcblx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9O1xyXG5cclxuXHRcdFx0fTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdHN0YXRpYyBzdG9yZVJlc3RhdXJhbnREYXRhSW5JbmRleGVkREIoZGF0YSkge1xyXG5cdFx0Ly9Hb3QgdGhlIGRhdGEsIG5vdyB3cml0dGluZyBpdCBpbiB0aGUgZGF0YWJhc2UuXHJcblx0XHRjb25zdCBEQk9wZW5SZXF1ZXN0ID0gREJIZWxwZXIuZGF0YWJhc2U7XHJcblx0XHREQkhlbHBlci51cGdhZGVJbmRleGVkREIoREJPcGVuUmVxdWVzdCk7XHJcblx0XHRpZiAoREJPcGVuUmVxdWVzdCkge1xyXG5cdFx0XHREQk9wZW5SZXF1ZXN0Lm9uc3VjY2VzcyA9IGV2ZW50ID0+IHtcclxuXHRcdFx0XHRjb25zdCBkYiA9IERCT3BlblJlcXVlc3QucmVzdWx0O1xyXG5cdFx0XHRcdGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ3JyZXZpZXdzJywgJ3JlYWR3cml0ZScpO1xyXG5cdFx0XHRcdGNvbnN0IHN0b3JlID0gdHgub2JqZWN0U3RvcmUoJ3JyZXZpZXdzJyk7XHJcblx0XHRcdFx0ZGF0YS5mb3JFYWNoKChyZXN0YXVyYW50KSA9PiB7XHJcblx0XHRcdFx0XHRzdG9yZS5wdXQocmVzdGF1cmFudCk7XHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH07XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgc2V0UmVzdGF1cmFudEZhdm9yaXRlKGlkLCBzdGF0ZSkge1xyXG5cdFx0Ly9Hb3QgdGhlIGRhdGEsIG5vdyB3cml0dGluZyBpdCBpbiB0aGUgZGF0YWJhc2UuXHJcblx0XHQvL1dlIGNvdWxkIGhhdmUganVzdCB1c2VkIHJlc3BvbnNlIGZyb20gUFVUXHJcblx0XHQvL21ldGhvZCwgYnV0IGluIGNhc2Ugd2UncmUgb2ZmbGluZSBsZXQncyB1cGRhdGUgdGhlIGRiIGZpcnN0XHJcblx0XHRjb25zdCBEQk9wZW5SZXF1ZXN0ID0gREJIZWxwZXIuZGF0YWJhc2U7XHJcblx0XHREQkhlbHBlci51cGdhZGVJbmRleGVkREIoREJPcGVuUmVxdWVzdCk7XHJcblx0XHRpZiAoREJPcGVuUmVxdWVzdCkge1xyXG5cdFx0XHREQk9wZW5SZXF1ZXN0Lm9uc3VjY2VzcyA9IChldmVudCkgPT4ge1xyXG5cdFx0XHRcdGNvbnN0IGRiID0gREJPcGVuUmVxdWVzdC5yZXN1bHQ7XHJcblx0XHRcdFx0Y29uc3QgaW5kZXggPSBkYi50cmFuc2FjdGlvbihbJ3JyZXZpZXdzJ10sICdyZWFkd3JpdGUnKS5vYmplY3RTdG9yZSgncnJldmlld3MnKS5pbmRleCgnaWQnKTtcclxuXHRcdFx0XHRjb25zdCB1cmwgPSBgJHt0aGlzLlJFU1RBVVJBTlRfVVJMfSR7aWR9Lz9pc19mYXZvcml0ZT0ke3N0YXRlfWA7XHJcblx0XHRcdFx0aW5kZXgub3BlbkN1cnNvcigpLm9uc3VjY2VzcyA9IChldmVudCkgPT4ge1xyXG5cdFx0XHRcdFx0Y29uc3QgY3Vyc29yID0gZXZlbnQudGFyZ2V0LnJlc3VsdDtcclxuXHRcdFx0XHRcdGlmIChjdXJzb3IpIHtcclxuXHRcdFx0XHRcdFx0aWYgKGN1cnNvci52YWx1ZS5pZCA9PSBpZCkge1xyXG5cdFx0XHRcdFx0XHRcdGN1cnNvci52YWx1ZS5pc19mYXZvcml0ZSA9IHN0YXRlO1xyXG5cdFx0XHRcdFx0XHRcdGN1cnNvci51cGRhdGUoY3Vyc29yLnZhbHVlKTtcclxuXHRcdFx0XHRcdFx0XHRjb25zdCByZXEgPSBuZXcgUmVxdWVzdCh1cmwsIHtcclxuXHRcdFx0XHRcdFx0XHRcdG1ldGhvZDogJ1BVVCdcclxuXHRcdFx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHRcdFx0XHRmZXRjaChyZXEpLmNhdGNoKGUgPT4ge1xyXG5cdFx0XHRcdFx0XHRcdFx0aWYoIW5hdmlnYXRvci5vbkxpbmUpe1xyXG5cdFx0XHRcdFx0XHRcdFx0XHR0aGlzLmFkZFJlcXVlc3RUb1F1ZXVlKHtcclxuXHRcdFx0XHRcdFx0XHRcdFx0XHQndXJsJzogdXJsLCBcclxuXHRcdFx0XHRcdFx0XHRcdFx0XHQnb3B0aW9ucyc6IHtcclxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdG1ldGhvZDogJ1BVVCdcclxuXHRcdFx0XHRcdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdFx0XHRcdGN1cnNvci5jb250aW51ZSgpO1xyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fTtcclxuXHJcblx0XHRcdH07XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgYWRkUmVzdGF1cmFudFJldmlldyhkYXRhKSB7XHJcblx0XHRjb25zdCByZXEgPSBuZXcgUmVxdWVzdCh0aGlzLlJFVklFV19VUkwsIHtcclxuXHRcdFx0Ym9keTogSlNPTi5zdHJpbmdpZnkoZGF0YSksXHJcblx0XHRcdG1ldGhvZDogJ1BPU1QnXHJcblx0XHR9KTtcclxuXHRcdGZldGNoKHJlcSkudGhlbihyZXNwb25zZSA9PiB7XHJcblx0XHRcdHJldHVybiByZXNwb25zZS5qc29uKCk7XHJcblx0XHR9KS50aGVuKHJldmlldyA9PiB7XHJcblx0XHRcdC8vZG8gYSByZWZyZXNoXHJcblx0XHRcdHRoaXMuZmV0Y2hSZXN0YXVyYW50QnlJZChkYXRhLnJlc3RhdXJhbnRfaWQsIHt9KTtcclxuXHRcdH0pLmNhdGNoKGUgPT4ge1xyXG5cdFx0XHRpZighbmF2aWdhdG9yLm9uTGluZSl7XHJcblx0XHRcdFx0dGhpcy5hZGRSZXF1ZXN0VG9RdWV1ZSh7XHJcblx0XHRcdFx0XHR1cmw6IHRoaXMuUkVWSUVXX1VSTCwgXHJcblx0XHRcdFx0XHRvcHRpb25zOiB7XHJcblx0XHRcdFx0XHRcdGJvZHk6IEpTT04uc3RyaW5naWZ5KGRhdGEpLFxyXG5cdFx0XHRcdFx0XHRtZXRob2Q6ICdQT1NUJ1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHR9XHJcblx0XHRcdHRoaXMuZmV0Y2hSZXN0YXVyYW50QnlJZChkYXRhLnJlc3RhdXJhbnRfaWQsIChlcnIsIHJzdCkgPT4ge1xyXG5cdFx0XHRcdHJzdC5yZXZpZXdzLnB1c2goZGF0YSk7XHJcblx0XHRcdFx0Y29uc3QgREJPcGVuUmVxdWVzdCA9IERCSGVscGVyLmRhdGFiYXNlO1xyXG5cdFx0XHRcdERCSGVscGVyLnVwZ2FkZUluZGV4ZWREQihEQk9wZW5SZXF1ZXN0KTtcclxuXHRcdFx0XHRpZiAoREJPcGVuUmVxdWVzdCkge1xyXG5cdFx0XHRcdFx0REJPcGVuUmVxdWVzdC5vbnN1Y2Nlc3MgPSAoZXZlbnQpID0+IHtcclxuXHRcdFx0XHRcdFx0Y29uc3QgZGIgPSBEQk9wZW5SZXF1ZXN0LnJlc3VsdDtcclxuXHRcdFx0XHRcdFx0ZGIudHJhbnNhY3Rpb24oWydycmV2aWV3cyddLCAncmVhZHdyaXRlJykub2JqZWN0U3RvcmUoJ3JyZXZpZXdzJykucHV0KHJzdCk7XHJcblx0XHRcdFx0XHR9O1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSk7XHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdHN0YXRpYyBnZXRSZXN0YXVyYW50RGF0YUZyb21JbmRleGVkREIoKSB7XHJcblx0XHQvL0l0IHNlZW1zIGxpa2Ugd2UndmUgZ290IGFuIGVycm9yIHdoaWxlIHRyeWluZyB0byByZWFkIGZyb20gdGhlIHNlcnZlclxyXG5cdFx0Ly9TbyB0cnlpbmcgdG8gZ2V0IGRhdGEgZnJvbSB0aGUgaW5kZXhlZERCIG5vd1xyXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuXHRcdFx0Y29uc3QgREJPcGVuUmVxdWVzdCA9IERCSGVscGVyLmRhdGFiYXNlO1xyXG5cdFx0XHREQkhlbHBlci51cGdhZGVJbmRleGVkREIoREJPcGVuUmVxdWVzdCk7XHJcblx0XHRcdGlmIChEQk9wZW5SZXF1ZXN0KSB7XHJcblx0XHRcdFx0REJPcGVuUmVxdWVzdC5vbnN1Y2Nlc3MgPSBldmVudCA9PiB7XHJcblx0XHRcdFx0XHRjb25zdCBkYiA9IERCT3BlblJlcXVlc3QucmVzdWx0O1xyXG5cdFx0XHRcdFx0Y29uc3Qgc3RvcmUgPSBkYi50cmFuc2FjdGlvbigncnJldmlld3MnLCAncmVhZG9ubHknKS5vYmplY3RTdG9yZSgncnJldmlld3MnKTtcclxuXHRcdFx0XHRcdGNvbnN0IGRhdGEgPSBbXTtcclxuXHRcdFx0XHRcdHN0b3JlLm9wZW5DdXJzb3IoKS5vbnN1Y2Nlc3MgPSBldmVudCA9PiB7XHJcblx0XHRcdFx0XHRcdGNvbnN0IGN1cnNvciA9IGV2ZW50LnRhcmdldC5yZXN1bHQ7XHJcblx0XHRcdFx0XHRcdGlmIChjdXJzb3IpIHtcclxuXHRcdFx0XHRcdFx0XHRkYXRhLnB1c2goY3Vyc29yLnZhbHVlKTtcclxuXHRcdFx0XHRcdFx0XHRjdXJzb3IuY29udGludWUoKTtcclxuXHRcdFx0XHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRcdFx0XHRyZXNvbHZlKGRhdGEpO1xyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHR9O1xyXG5cdFx0XHRcdH07XHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cdH1cclxuXHJcblx0c3RhdGljIHVwZ2FkZUluZGV4ZWREQihEQk9wZW5SZXF1ZXN0KSB7XHJcblx0XHREQk9wZW5SZXF1ZXN0Lm9udXBncmFkZW5lZWRlZCA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0Y29uc3QgZGIgPSBEQk9wZW5SZXF1ZXN0LnJlc3VsdDtcclxuXHRcdFx0Y29uc3Qgc3RvcmUgPSBkYi5jcmVhdGVPYmplY3RTdG9yZSgncnJldmlld3MnLCB7XHJcblx0XHRcdFx0a2V5UGF0aDogJ2lkJ1xyXG5cdFx0XHR9KTtcclxuXHRcdFx0c3RvcmUuY3JlYXRlSW5kZXgoJ25hbWUnLCAnbmFtZScpO1xyXG5cdFx0XHRzdG9yZS5jcmVhdGVJbmRleCgnaWQnLCAnaWQnLCB7XHJcblx0XHRcdFx0dW5pcXVlOiB0cnVlXHJcblx0XHRcdH0pO1xyXG5cdFx0XHRkYi5jcmVhdGVPYmplY3RTdG9yZSgncmVxdWVzdHF1ZXVlJywgIHsgYXV0b0luY3JlbWVudCA6IHRydWUgfSk7XHJcblx0XHR9O1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogRmV0Y2ggcmVzdGF1cmFudHMgYnkgYSBjdWlzaW5lIHR5cGUgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcblx0ICovXHJcblx0c3RhdGljIGZldGNoUmVzdGF1cmFudEJ5Q3Vpc2luZShjdWlzaW5lLCBjYWxsYmFjaykge1xyXG5cdFx0Ly8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzICB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZ1xyXG5cdFx0REJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cygoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcblx0XHRcdGlmIChlcnJvcikge1xyXG5cdFx0XHRcdGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHQvLyBGaWx0ZXIgcmVzdGF1cmFudHMgdG8gaGF2ZSBvbmx5IGdpdmVuIGN1aXNpbmUgdHlwZVxyXG5cdFx0XHRcdGNvbnN0IHJlc3VsdHMgPSByZXN0YXVyYW50cy5maWx0ZXIociA9PiByLmN1aXNpbmVfdHlwZSA9PSBjdWlzaW5lKTtcclxuXHRcdFx0XHRjYWxsYmFjayhudWxsLCByZXN1bHRzKTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIG5laWdoYm9yaG9vZCB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuXHQgKi9cclxuXHRzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlOZWlnaGJvcmhvb2QobmVpZ2hib3Job29kLCBjYWxsYmFjaykge1xyXG5cdFx0Ly8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcblx0XHREQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuXHRcdFx0aWYgKGVycm9yKSB7XHJcblx0XHRcdFx0Y2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdC8vIEZpbHRlciByZXN0YXVyYW50cyB0byBoYXZlIG9ubHkgZ2l2ZW4gbmVpZ2hib3Job29kXHJcblx0XHRcdFx0Y29uc3QgcmVzdWx0cyA9IHJlc3RhdXJhbnRzLmZpbHRlcihyID0+IHIubmVpZ2hib3Job29kID09IG5laWdoYm9yaG9vZCk7XHJcblx0XHRcdFx0Y2FsbGJhY2sobnVsbCwgcmVzdWx0cyk7XHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogRmV0Y2ggcmVzdGF1cmFudHMgYnkgYSBjdWlzaW5lIGFuZCBhIG5laWdoYm9yaG9vZCB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuXHQgKi9cclxuXHRzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lQW5kTmVpZ2hib3Job29kKGN1aXNpbmUsIG5laWdoYm9yaG9vZCwgY2FsbGJhY2spIHtcclxuXHRcdC8vIEZldGNoIGFsbCByZXN0YXVyYW50c1xyXG5cdFx0REJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cygoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcblx0XHRcdGlmIChlcnJvcikge1xyXG5cdFx0XHRcdGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRsZXQgcmVzdWx0cyA9IHJlc3RhdXJhbnRzO1xyXG5cdFx0XHRcdGlmIChjdWlzaW5lICE9ICdhbGwnKSB7IC8vIGZpbHRlciBieSBjdWlzaW5lXHJcblx0XHRcdFx0XHRyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLmN1aXNpbmVfdHlwZSA9PSBjdWlzaW5lKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0aWYgKG5laWdoYm9yaG9vZCAhPSAnYWxsJykgeyAvLyBmaWx0ZXIgYnkgbmVpZ2hib3Job29kXHJcblx0XHRcdFx0XHRyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLm5laWdoYm9yaG9vZCA9PSBuZWlnaGJvcmhvb2QpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRjYWxsYmFjayhudWxsLCByZXN1bHRzKTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBGZXRjaCBhbGwgbmVpZ2hib3Job29kcyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuXHQgKi9cclxuXHRzdGF0aWMgZmV0Y2hOZWlnaGJvcmhvb2RzKGNhbGxiYWNrKSB7XHJcblx0XHQvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuXHRcdERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG5cdFx0XHRpZiAoZXJyb3IpIHtcclxuXHRcdFx0XHRjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcblx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0Ly8gR2V0IGFsbCBuZWlnaGJvcmhvb2RzIGZyb20gYWxsIHJlc3RhdXJhbnRzXHJcblx0XHRcdFx0Y29uc3QgbmVpZ2hib3Job29kcyA9IHJlc3RhdXJhbnRzLm1hcCgodiwgaSkgPT4gcmVzdGF1cmFudHNbaV0ubmVpZ2hib3Job29kKTtcclxuXHRcdFx0XHQvLyBSZW1vdmUgZHVwbGljYXRlcyBmcm9tIG5laWdoYm9yaG9vZHNcclxuXHRcdFx0XHRjb25zdCB1bmlxdWVOZWlnaGJvcmhvb2RzID0gbmVpZ2hib3Job29kcy5maWx0ZXIoKHYsIGkpID0+IG5laWdoYm9yaG9vZHMuaW5kZXhPZih2KSA9PSBpKTtcclxuXHRcdFx0XHRjYWxsYmFjayhudWxsLCB1bmlxdWVOZWlnaGJvcmhvb2RzKTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBGZXRjaCBhbGwgY3Vpc2luZXMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcblx0ICovXHJcblx0c3RhdGljIGZldGNoQ3Vpc2luZXMoY2FsbGJhY2spIHtcclxuXHRcdC8vIEZldGNoIGFsbCByZXN0YXVyYW50c1xyXG5cdFx0REJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cygoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcblx0XHRcdGlmIChlcnJvcikge1xyXG5cdFx0XHRcdGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHQvLyBHZXQgYWxsIGN1aXNpbmVzIGZyb20gYWxsIHJlc3RhdXJhbnRzXHJcblx0XHRcdFx0Y29uc3QgY3Vpc2luZXMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLmN1aXNpbmVfdHlwZSk7XHJcblx0XHRcdFx0Ly8gUmVtb3ZlIGR1cGxpY2F0ZXMgZnJvbSBjdWlzaW5lc1xyXG5cdFx0XHRcdGNvbnN0IHVuaXF1ZUN1aXNpbmVzID0gY3Vpc2luZXMuZmlsdGVyKCh2LCBpKSA9PiBjdWlzaW5lcy5pbmRleE9mKHYpID09IGkpO1xyXG5cdFx0XHRcdGNhbGxiYWNrKG51bGwsIHVuaXF1ZUN1aXNpbmVzKTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBSZXN0YXVyYW50IHBhZ2UgVVJMLlxyXG5cdCAqL1xyXG5cdHN0YXRpYyB1cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpIHtcclxuXHRcdHJldHVybiAoYC4vcmVzdGF1cmFudC5odG1sP2lkPSR7cmVzdGF1cmFudC5pZH1gKTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIFJlc3RhdXJhbnQgaW1hZ2UgVVJMLlxyXG5cdCAqL1xyXG5cdHN0YXRpYyBpbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkge1xyXG5cdFx0cmV0dXJuIChgL2ltZy8ke3Jlc3RhdXJhbnQucGhvdG9ncmFwaCA/IHJlc3RhdXJhbnQucGhvdG9ncmFwaCA6IHJlc3RhdXJhbnQuaWR9YCk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBNYXAgbWFya2VyIGZvciBhIHJlc3RhdXJhbnQuXHJcblx0ICovXHJcblx0c3RhdGljIG1hcE1hcmtlckZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgbWFwKSB7XHJcblx0XHRjb25zdCBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcclxuXHRcdFx0cG9zaXRpb246IHJlc3RhdXJhbnQubGF0bG5nLFxyXG5cdFx0XHR0aXRsZTogcmVzdGF1cmFudC5uYW1lLFxyXG5cdFx0XHR1cmw6IERCSGVscGVyLnVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCksXHJcblx0XHRcdG1hcDogbWFwLFxyXG5cdFx0XHRhbmltYXRpb246IGdvb2dsZS5tYXBzLkFuaW1hdGlvbi5EUk9QXHJcblx0XHR9KTtcclxuXHRcdHJldHVybiBtYXJrZXI7XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgYWRkUmVxdWVzdFRvUXVldWUocmVxdWVzdCl7XHJcblx0XHRjb25zdCBEQk9wZW5SZXF1ZXN0ID0gREJIZWxwZXIuZGF0YWJhc2U7XHJcblx0XHREQkhlbHBlci51cGdhZGVJbmRleGVkREIoREJPcGVuUmVxdWVzdCk7XHJcblx0XHRpZiAoREJPcGVuUmVxdWVzdCkge1xyXG5cdFx0XHREQk9wZW5SZXF1ZXN0Lm9uc3VjY2VzcyA9IGV2ZW50ID0+IHtcclxuXHRcdFx0XHRjb25zdCBkYiA9IERCT3BlblJlcXVlc3QucmVzdWx0O1xyXG5cdFx0XHRcdGRiLnRyYW5zYWN0aW9uKCdyZXF1ZXN0cXVldWUnLCAncmVhZHdyaXRlJykub2JqZWN0U3RvcmUoJ3JlcXVlc3RxdWV1ZScpLnB1dChyZXF1ZXN0KTtcclxuXHRcdFx0fTtcclxuXHRcdH1cclxuXHR9XHJcblx0c3RhdGljIHNlbmRRdWV1ZWRSZXF1ZXN0cygpIHtcclxuXHRcdGNvbnN0IERCT3BlblJlcXVlc3QgPSBEQkhlbHBlci5kYXRhYmFzZTtcclxuXHRcdERCSGVscGVyLnVwZ2FkZUluZGV4ZWREQihEQk9wZW5SZXF1ZXN0KTtcclxuXHRcdGlmIChEQk9wZW5SZXF1ZXN0KSB7XHJcblx0XHRcdERCT3BlblJlcXVlc3Qub25zdWNjZXNzID0gZXZlbnQgPT4ge1xyXG5cdFx0XHRcdGNvbnN0IGRiID0gREJPcGVuUmVxdWVzdC5yZXN1bHQ7XHJcblx0XHRcdFx0Y29uc3Qgc3RvcmUgPSBkYi50cmFuc2FjdGlvbigncmVxdWVzdHF1ZXVlJywgJ3JlYWR3cml0ZScpLm9iamVjdFN0b3JlKCdyZXF1ZXN0cXVldWUnKTtcclxuXHRcdFx0XHRzdG9yZS5vcGVuQ3Vyc29yKCkub25zdWNjZXNzID0gZXZlbnQgPT4ge1xyXG5cdFx0XHRcdFx0Y29uc3QgY3Vyc29yID0gZXZlbnQudGFyZ2V0LnJlc3VsdDtcclxuXHRcdFx0XHRcdGlmIChjdXJzb3IpIHtcclxuXHRcdFx0XHRcdFx0Y29uc3QgcmVxdWVzdCA9IG5ldyBSZXF1ZXN0KGN1cnNvci52YWx1ZS51cmwsIGN1cnNvci52YWx1ZS5vcHRpb25zKTtcclxuXHRcdFx0XHRcdFx0ZmV0Y2gocmVxdWVzdCk7XHJcblx0XHRcdFx0XHRcdGN1cnNvci5kZWxldGUoKTtcclxuXHRcdFx0XHRcdFx0Y3Vyc29yLmNvbnRpbnVlKCk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fTtcclxuXHRcdFx0fTtcclxuXHRcdH1cclxuXHR9XHJcbn1cclxuLyplc2xpbnQgbm8tY29uc29sZTogMCovXHJcbi8qZXNsaW50IG5vLXVudXNlZC12YXJzOiAwKi9cclxuLyplc2xpbnQgbm8tdW5kZWY6IDAqL1xyXG4vKipcclxuICogRmV0Y2ggbmVpZ2hib3Job29kcyBhbmQgY3Vpc2luZXMgYXMgc29vbiBhcyB0aGUgcGFnZSBpcyBsb2FkZWQuXHJcbiAqL1xyXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgKGV2ZW50KSA9PiB7XHJcblx0ZmV0Y2hOZWlnaGJvcmhvb2RzKCk7XHJcblx0ZmV0Y2hDdWlzaW5lcygpO1xyXG59KTtcclxuXHJcbmxldCBtYXA7XHJcblxyXG5jb25zdCBvYnNlcnZlciA9IG5ldyBJbnRlcnNlY3Rpb25PYnNlcnZlcihvbkludGVyc2VjdGlvbiwge1xyXG5cdHJvb3RNYXJnaW46ICcwcHgnLFxyXG5cdHRocmVzaG9sZDogMC4xXHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gb25JbnRlcnNlY3Rpb24oZW50cmllcykge1xyXG5cdC8vIExvb3AgdGhyb3VnaCB0aGUgZW50cmllc1xyXG5cdGVudHJpZXMuZm9yRWFjaChlbnRyeSA9PiB7XHJcblx0XHQvLyBBcmUgd2UgaW4gdmlld3BvcnQ/XHJcblx0XHRpZiAoZW50cnkuaW50ZXJzZWN0aW9uUmF0aW8gPiAwKSB7XHJcblxyXG5cdFx0XHQvLyBTdG9wIHdhdGNoaW5nIGFuZCBsb2FkIHRoZSBpbWFnZVxyXG5cdFx0XHRvYnNlcnZlci51bm9ic2VydmUoZW50cnkudGFyZ2V0KTtcclxuXHRcdFx0bG9hZEltYWdlKGVudHJ5LnRhcmdldCk7XHJcblx0XHR9XHJcblx0fSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGxvYWRJbWFnZShpbWFnZSkge1xyXG5cdGNvbnN0IHNyYyA9IGltYWdlLmRhdGFzZXQuc3JjO1xyXG5cdGZldGNoSW1hZ2Uoc3JjKS50aGVuKCgpID0+IHtcclxuXHRcdGltYWdlLnNyYyA9IHNyYztcclxuXHR9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gZmV0Y2hJbWFnZSh1cmwpIHtcclxuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG5cdFx0Y29uc3QgaW1hZ2UgPSBuZXcgSW1hZ2UoKTtcclxuXHRcdGltYWdlLnNyYyA9IHVybDtcclxuXHRcdGltYWdlLm9ubG9hZCA9IHJlc29sdmU7XHJcblx0XHRpbWFnZS5vbmVycm9yID0gcmVqZWN0O1xyXG5cdH0pO1xyXG59XHJcblxyXG5cclxuXHJcbi8qKlxyXG4gKiBGZXRjaCBhbGwgbmVpZ2hib3Job29kcyBhbmQgc2V0IHRoZWlyIEhUTUwuXHJcbiAqL1xyXG5mdW5jdGlvbiBmZXRjaE5laWdoYm9yaG9vZHMoKSB7XHJcblx0REJIZWxwZXIuZmV0Y2hOZWlnaGJvcmhvb2RzKChlcnJvciwgbmVpZ2hib3Job29kcykgPT4ge1xyXG5cdFx0aWYgKGVycm9yKSB7IC8vIEdvdCBhbiBlcnJvclxyXG5cdFx0XHRjb25zb2xlLmVycm9yKGVycm9yKTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHRoaXMubmVpZ2hib3Job29kcyA9IG5laWdoYm9yaG9vZHM7XHJcblx0XHRcdGZpbGxOZWlnaGJvcmhvb2RzSFRNTCgpO1xyXG5cdFx0fVxyXG5cdH0pO1xyXG59XHJcblxyXG4vKipcclxuICogU2V0IG5laWdoYm9yaG9vZHMgSFRNTC5cclxuICovXHJcbmZ1bmN0aW9uIGZpbGxOZWlnaGJvcmhvb2RzSFRNTChuZWlnaGJvcmhvb2RzID0gdGhpcy5uZWlnaGJvcmhvb2RzKSB7XHJcblx0Y29uc3Qgc2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25laWdoYm9yaG9vZHMtc2VsZWN0Jyk7XHJcblx0aWYgKHNlbGVjdCkge1xyXG5cdFx0bmVpZ2hib3Job29kcy5mb3JFYWNoKG5laWdoYm9yaG9vZCA9PiB7XHJcblx0XHRcdGNvbnN0IG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpO1xyXG5cdFx0XHRvcHRpb24uaW5uZXJIVE1MID0gbmVpZ2hib3Job29kO1xyXG5cdFx0XHRvcHRpb24udmFsdWUgPSBuZWlnaGJvcmhvb2Q7XHJcblx0XHRcdHNlbGVjdC5hcHBlbmRDaGlsZChvcHRpb24pO1xyXG5cdFx0fSk7XHJcblx0fVxyXG59XHJcblxyXG4vKipcclxuICogRmV0Y2ggYWxsIGN1aXNpbmVzIGFuZCBzZXQgdGhlaXIgSFRNTC5cclxuICovXHJcbmZ1bmN0aW9uIGZldGNoQ3Vpc2luZXMoKSB7XHJcblx0REJIZWxwZXIuZmV0Y2hDdWlzaW5lcygoZXJyb3IsIGN1aXNpbmVzKSA9PiB7XHJcblx0XHRpZiAoZXJyb3IpIHsgLy8gR290IGFuIGVycm9yIVxyXG5cdFx0XHRjb25zb2xlLmVycm9yKGVycm9yKTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHRoaXMuY3Vpc2luZXMgPSBjdWlzaW5lcztcclxuXHRcdFx0ZmlsbEN1aXNpbmVzSFRNTCgpO1xyXG5cdFx0fVxyXG5cdH0pO1xyXG59XHJcblxyXG4vKipcclxuICogU2V0IGN1aXNpbmVzIEhUTUwuXHJcbiAqL1xyXG5mdW5jdGlvbiBmaWxsQ3Vpc2luZXNIVE1MKGN1aXNpbmVzID0gdGhpcy5jdWlzaW5lcykge1xyXG5cdGNvbnN0IHNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdWlzaW5lcy1zZWxlY3QnKTtcclxuXHRpZiAoc2VsZWN0KSB7XHJcblx0XHRjdWlzaW5lcy5mb3JFYWNoKGN1aXNpbmUgPT4ge1xyXG5cdFx0XHRjb25zdCBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKTtcclxuXHRcdFx0b3B0aW9uLmlubmVySFRNTCA9IGN1aXNpbmU7XHJcblx0XHRcdG9wdGlvbi52YWx1ZSA9IGN1aXNpbmU7XHJcblx0XHRcdHNlbGVjdC5hcHBlbmRDaGlsZChvcHRpb24pO1xyXG5cdFx0fSk7XHJcblx0fVxyXG59XHJcblxyXG4vKipcclxuICogSW5pdGlhbGl6ZSBHb29nbGUgbWFwLCBjYWxsZWQgZnJvbSBIVE1MLlxyXG4gKi9cclxud2luZG93LmluaXRNYXAgPSAoKSA9PiB7XHJcblx0bGV0IGxvYyA9IHtcclxuXHRcdGxhdDogNDAuNzIyMjE2LFxyXG5cdFx0bG5nOiAtNzMuOTg3NTAxXHJcblx0fTtcclxuXHR0aGlzLm1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcCcpLCB7XHJcblx0XHR6b29tOiAxMixcclxuXHRcdGNlbnRlcjogbG9jLFxyXG5cdFx0c2Nyb2xsd2hlZWw6IGZhbHNlXHJcblx0fSk7XHJcblx0dXBkYXRlUmVzdGF1cmFudHMoKTtcclxufTtcclxuXHJcbi8qKlxyXG4gKiBVcGRhdGUgcGFnZSBhbmQgbWFwIGZvciBjdXJyZW50IHJlc3RhdXJhbnRzLlxyXG4gKi9cclxuZnVuY3Rpb24gdXBkYXRlUmVzdGF1cmFudHMoKSB7XHJcblx0Y29uc3QgY1NlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdWlzaW5lcy1zZWxlY3QnKTtcclxuXHRjb25zdCBuU2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25laWdoYm9yaG9vZHMtc2VsZWN0Jyk7XHJcblxyXG5cdGNvbnN0IGNJbmRleCA9IGNTZWxlY3Quc2VsZWN0ZWRJbmRleDtcclxuXHRjb25zdCBuSW5kZXggPSBuU2VsZWN0LnNlbGVjdGVkSW5kZXg7XHJcblxyXG5cdGNvbnN0IGN1aXNpbmUgPSBjU2VsZWN0W2NJbmRleF0udmFsdWU7XHJcblx0Y29uc3QgbmVpZ2hib3Job29kID0gblNlbGVjdFtuSW5kZXhdLnZhbHVlO1xyXG5cclxuXHREQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QoY3Vpc2luZSwgbmVpZ2hib3Job29kLCAoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcblx0XHRpZiAoZXJyb3IpIHsgLy8gR290IGFuIGVycm9yIVxyXG5cdFx0XHRjb25zb2xlLmVycm9yKGVycm9yKTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHJlc2V0UmVzdGF1cmFudHMocmVzdGF1cmFudHMpO1xyXG5cdFx0XHRmaWxsUmVzdGF1cmFudHNIVE1MKCk7XHJcblx0XHR9XHJcblx0fSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDbGVhciBjdXJyZW50IHJlc3RhdXJhbnRzLCB0aGVpciBIVE1MIGFuZCByZW1vdmUgdGhlaXIgbWFwIG1hcmtlcnMuXHJcbiAqL1xyXG5mdW5jdGlvbiByZXNldFJlc3RhdXJhbnRzKHJlc3RhdXJhbnRzKSB7XHJcblx0Ly8gUmVtb3ZlIGFsbCByZXN0YXVyYW50c1xyXG5cdHRoaXMucmVzdGF1cmFudHMgPSBbXTtcclxuXHRjb25zdCB1bCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50cy1saXN0Jyk7XHJcblx0dWwuaW5uZXJIVE1MID0gJyc7XHJcblxyXG5cdC8vIFJlbW92ZSBhbGwgbWFwIG1hcmtlcnNcclxuXHRpZiAodGhpcy5tYXJrZXJzKSB7XHJcblx0XHR0aGlzLm1hcmtlcnMuZm9yRWFjaChtID0+IG0uc2V0TWFwKG51bGwpKTtcclxuXHR9XHJcblx0dGhpcy5tYXJrZXJzID0gW107XHJcblx0dGhpcy5yZXN0YXVyYW50cyA9IHJlc3RhdXJhbnRzO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzdGFydE9ic2VydmVyKCkge1xyXG5cdGNvbnN0IGltYWdlcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5yZXN0YXVyYW50LWltZycpO1xyXG5cdGltYWdlcy5mb3JFYWNoKGltYWdlID0+IHtcclxuXHRcdG9ic2VydmVyLm9ic2VydmUoaW1hZ2UpO1xyXG5cdH0pO1xyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlIGFsbCByZXN0YXVyYW50cyBIVE1MIGFuZCBhZGQgdGhlbSB0byB0aGUgd2VicGFnZS5cclxuICovXHJcbmZ1bmN0aW9uIGZpbGxSZXN0YXVyYW50c0hUTUwocmVzdGF1cmFudHMgPSB0aGlzLnJlc3RhdXJhbnRzKSB7XHJcblx0Y29uc3QgdWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudHMtbGlzdCcpO1xyXG5cdHJlc3RhdXJhbnRzLmZvckVhY2gocmVzdGF1cmFudCA9PiB7XHJcblx0XHR1bC5hcHBlbmRDaGlsZChjcmVhdGVSZXN0YXVyYW50SFRNTChyZXN0YXVyYW50KSk7XHJcblx0fSk7XHJcblx0c3RhcnRPYnNlcnZlcigpO1xyXG5cdGFkZE1hcmtlcnNUb01hcCgpO1xyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlIHJlc3RhdXJhbnQgSFRNTC5cclxuICovXHJcbmZ1bmN0aW9uIGNyZWF0ZVJlc3RhdXJhbnRIVE1MKHJlc3RhdXJhbnQpIHtcclxuXHRpZiAodHlwZW9mIHJlc3RhdXJhbnQuaXNfZmF2b3JpdGUgPT09ICd1bmRlZmluZWQnKSB7XHJcblx0XHRyZXN0YXVyYW50LmlzX2Zhdm9yaXRlID0gZmFsc2U7XHJcblx0fVxyXG5cdGNvbnN0IGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcclxuXHRsaS5jbGFzc05hbWUgPSAncmVzdGF1cmFudC1jYXJkJztcclxuXHJcblx0Y29uc3QgcGljdHVyZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3BpY3R1cmUnKTsgLy9IZXJlIGdvZXMgdGhlIG5ldyBwaWN0dXJlIHRhZywgdGhhdCB3aWxsIGluY2x1ZGUgdGhlIDxpbWc+XHJcblx0cGljdHVyZS5jbGFzc05hbWUgPSAncmVzdGF1cmFudC1waWN0dXJlJzsgLy90aGF0IGlzIGhvdyB3ZSB3aWxsIHNlcnZlIGRpZmVyZW50IHNpemVzIG9mIGltYWdlc1xyXG5cclxuXHQvL25leHQgYmxvY2sgcHJlcGFyZXMgc291cmNlIHRhZyBmb3Igc21hbGwgaW1hZ2VzXHJcblx0Y29uc3Qgc3JjU21hbGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzb3VyY2UnKTtcclxuXHRzcmNTbWFsbC5jbGFzc05hbWUgPSAnc291cmNlLXNtYWxsJztcclxuXHRsZXQgcGljVXJsU21hbGwgPSBEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkuY29uY2F0KCctc21hbGwuanBnJyk7XHJcblx0bGV0IHBpY1VybE1lZGl1bSA9IHBpY1VybFNtYWxsLnJlcGxhY2UoJ3NtYWxsJywgJ21lZGl1bScpO1xyXG5cdHNyY1NtYWxsLnNyY3NldCA9IHBpY1VybFNtYWxsICsgJyAxeCwgJyArIHBpY1VybE1lZGl1bSArICcgMngnO1xyXG5cdHBpY3R1cmUuYXBwZW5kQ2hpbGQoc3JjU21hbGwpO1xyXG5cclxuXHQvL25leHQgYmxvY2sgcHJlcGFyZXMgc291cmNlIHRhZyBmb3IgbGFyZ2UgaW1hZ2VzXHJcblx0Y29uc3Qgc3JjTGFyZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzb3VyY2UnKTtcclxuXHRzcmNMYXJnZS5jbGFzc05hbWUgPSAnc291cmNlLWxhcmdlJztcclxuXHRsZXQgcGljVXJsTGFyZ2UgPSBwaWNVcmxTbWFsbC5yZXBsYWNlKCdzbWFsbCcsICdsYXJnZScpO1xyXG5cdHNyY0xhcmdlLnNyY3NldCA9IHBpY1VybE1lZGl1bSArICcgMXgsICcgKyBwaWNVcmxMYXJnZSArICcgMngnO1xyXG5cdHNyY0xhcmdlLm1lZGlhID0gJyhtaW4td2lkdGg6IDc1MHB4KSc7XHJcblx0cGljdHVyZS5hcHBlbmRDaGlsZChzcmNMYXJnZSk7XHJcblxyXG5cdC8vY3JlYXRpbmcgaW1nIHRhZywgYW5kIGFkZGluZyBhbHRcclxuXHRjb25zdCBpbWFnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xyXG5cdGltYWdlLmNsYXNzTmFtZSA9ICdyZXN0YXVyYW50LWltZyc7XHJcblx0aW1hZ2UuYWx0ID0gJ0ltYWdlIG9mIFwiJyArIHJlc3RhdXJhbnQubmFtZSArICdcIiByZXN0YXVyYW50Lic7XHJcblx0Ly9pbWFnZS5zcmMgPSBwaWNVcmxTbWFsbDtcclxuXHRpbWFnZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3JjJywgcGljVXJsU21hbGwpO1xyXG5cdHBpY3R1cmUuYXBwZW5kQ2hpbGQoaW1hZ2UpO1xyXG5cclxuXHRjb25zdCBpbmZvQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcblx0aW5mb0NvbnRhaW5lci5jbGFzc05hbWUgPSAncmVzdGF1cmFudC1pbmZvLWNvbnRhaW5lcic7XHJcblx0aW5mb0NvbnRhaW5lci5hcHBlbmRDaGlsZChwaWN0dXJlKTtcclxuXHJcblx0XHJcblx0Y29uc3QgbmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gyJyk7XHJcblx0bmFtZS5pbm5lckhUTUwgPSByZXN0YXVyYW50Lm5hbWU7XHJcblx0aW5mb0NvbnRhaW5lci5hcHBlbmRDaGlsZChuYW1lKTtcclxuXHRcclxuXHRjb25zdCBmYXZvcml0ZV9pY29uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xyXG5cdGNvbnN0IGZhdl9pY29uX2FyaWFfbGFiZWwgPSBKU09OLnBhcnNlKHJlc3RhdXJhbnQuaXNfZmF2b3JpdGUpID8gJ1JlbW92ZSByZXN0YXVyYW50ICcgKyByZXN0YXVyYW50Lm5hbWUgKyAnZnJvbSBmYXZvcml0ZXMuJyA6ICdBZGQgcmVzdGF1cmFudCAnICsgcmVzdGF1cmFudC5uYW1lICsgJ3RvIGZhdm9yaXRlcy4nO1xyXG5cdGZhdm9yaXRlX2ljb24uY2xhc3NOYW1lID0gJ3RhcC10YXJnZXQgdG9wLXJpZ2h0JztcclxuXHRmYXZvcml0ZV9pY29uLnNldEF0dHJpYnV0ZSgnYXJpYS1sYWJlbCcsIGZhdl9pY29uX2FyaWFfbGFiZWwpO1xyXG5cdGZhdm9yaXRlX2ljb24uc2V0QXR0cmlidXRlKCdyb2xlJywgJ2J1dHRvbicpO1xyXG5cdGZhdm9yaXRlX2ljb24uc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsICcwJyk7XHJcblx0ZmF2b3JpdGVfaWNvbi5zZXRBdHRyaWJ1dGUoJ2RhdGEtcmVzdGlkJywgcmVzdGF1cmFudC5pZCk7XHJcblx0ZmF2b3JpdGVfaWNvbi5zZXRBdHRyaWJ1dGUoJ2lzLWZhdm9yaXRlJywgcmVzdGF1cmFudC5pc19mYXZvcml0ZSk7XHJcblx0ZmF2b3JpdGVfaWNvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRvZ2dsZUZhdm9yaXRlLCBmYWxzZSk7XHJcblx0aW5mb0NvbnRhaW5lci5hcHBlbmRDaGlsZChmYXZvcml0ZV9pY29uKTtcclxuXHJcblx0Y29uc3QgZmF2b3JpdGVfc3ltYm9sID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaScpO1xyXG5cdGZhdm9yaXRlX3N5bWJvbC5jbGFzc05hbWUgPSAnbWF0ZXJpYWwtaWNvbnMgZmF2b3JpdGUtaWNvbic7XHJcblx0ZmF2b3JpdGVfc3ltYm9sLmlubmVySFRNTCA9IEpTT04ucGFyc2UocmVzdGF1cmFudC5pc19mYXZvcml0ZSkgPyAnZmF2b3JpdGUnIDonZmF2b3JpdGVfYm9yZGVyJztcclxuXHRmYXZvcml0ZV9pY29uLmFwcGVuZENoaWxkKGZhdm9yaXRlX3N5bWJvbCk7XHJcblx0XHJcblx0Y29uc3QgYWRkcmVzc0NvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG5cdGFkZHJlc3NDb250YWluZXIuY2xhc3NOYW1lID0gJ2FkZHJlc3MtY29udGFpbmVyJztcclxuXHJcblx0Y29uc3QgbmVpZ2hib3Job29kID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG5cdG5laWdoYm9yaG9vZC5zZXRBdHRyaWJ1dGUoJ2FyaWEtZGVzY3JpYmVkYnknLCAncmVzdGF1cmFudC1uZWlnaGJvcmhvb2QtbGFiZWwnKTtcclxuXHRuZWlnaGJvcmhvb2QuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5uZWlnaGJvcmhvb2Q7XHJcblx0YWRkcmVzc0NvbnRhaW5lci5hcHBlbmRDaGlsZChuZWlnaGJvcmhvb2QpO1xyXG5cclxuXHRjb25zdCBhZGRyZXNzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG5cdGFkZHJlc3MuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5hZGRyZXNzO1xyXG5cdGFkZHJlc3Muc2V0QXR0cmlidXRlKCdhcmlhLWRlc2NyaWJlZGJ5JywgJ3Jlc3RhdXJhbnQtYWRkcmVzcy1sYWJlbCcpO1xyXG5cdGFkZHJlc3NDb250YWluZXIuYXBwZW5kQ2hpbGQoYWRkcmVzcyk7XHJcblxyXG5cdGluZm9Db250YWluZXIuYXBwZW5kQ2hpbGQoYWRkcmVzc0NvbnRhaW5lcik7XHJcblxyXG5cdGxpLmFwcGVuZENoaWxkKGluZm9Db250YWluZXIpO1xyXG5cclxuXHRjb25zdCBtb3JlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xyXG5cdG1vcmUuaW5uZXJIVE1MID0gJ1ZpZXcgRGV0YWlscyc7XHJcblx0bW9yZS5jbGFzc05hbWUgPSAndGFwLXRhcmdldCByZXN0YXVyYW50LWNhcmQtZGV0YWlscyc7XHJcblx0bW9yZS5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGFiZWwnLCAnUmVzdGF1cmFudDogJyArIHJlc3RhdXJhbnQubmFtZSArICc6IHZpZXcgZGV0YWlscy4nKTtcclxuXHRtb3JlLnNldEF0dHJpYnV0ZSgncm9sZScsICdidXR0b24nKTtcclxuXHRtb3JlLmhyZWYgPSBEQkhlbHBlci51cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpO1xyXG5cdGxpLmFwcGVuZENoaWxkKG1vcmUpO1xyXG5cclxuXHRyZXR1cm4gbGk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBZGQgbWFya2VycyBmb3IgY3VycmVudCByZXN0YXVyYW50cyB0byB0aGUgbWFwLlxyXG4gKi9cclxuZnVuY3Rpb24gYWRkTWFya2Vyc1RvTWFwKHJlc3RhdXJhbnRzID0gdGhpcy5yZXN0YXVyYW50cykge1xyXG5cdHJlc3RhdXJhbnRzLmZvckVhY2gocmVzdGF1cmFudCA9PiB7XHJcblx0XHQvLyBBZGQgbWFya2VyIHRvIHRoZSBtYXBcclxuXHRcdGNvbnN0IG1hcmtlciA9IERCSGVscGVyLm1hcE1hcmtlckZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgdGhpcy5tYXApO1xyXG5cdFx0Z29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIobWFya2VyLCAnY2xpY2snLCAoKSA9PiB7XHJcblx0XHRcdHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gbWFya2VyLnVybDtcclxuXHRcdH0pO1xyXG5cdFx0dGhpcy5tYXJrZXJzLnB1c2gobWFya2VyKTtcclxuXHR9KTtcclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIHRvZ2dsZUZhdm9yaXRlKGUpIHtcclxuXHRpZiAoIWUpXHJcblx0XHRlID0gd2luZG93LmV2ZW50O1xyXG5cdGNvbnN0IHNlbmRlciA9IGUuc3JjRWxlbWVudCB8fCBlLnRhcmdldDtcclxuXHRjb25zdCBpZCA9IHRoaXMuZGF0YXNldC5yZXN0aWQ7XHJcblx0Ly9JbnZlcnRpbmcgdmFsdWUgaW4gdGUgbmV4dCBsaW5lXHJcblx0bGV0IHN0YXRlID0gSlNPTi5wYXJzZSh0aGlzLmdldEF0dHJpYnV0ZSgnaXMtZmF2b3JpdGUnKSkgPyBmYWxzZSA6IHRydWU7XHJcblx0XHJcblx0aWYoaWQpe1xyXG5cdFx0dGhpcy5zZXRBdHRyaWJ1dGUoJ2lzLWZhdm9yaXRlJyxzdGF0ZSk7XHJcblx0XHREQkhlbHBlci5zZXRSZXN0YXVyYW50RmF2b3JpdGUoaWQsIHN0YXRlKTtcclxuXHRcdGlmKHNlbmRlciA9PSB0aGlzKXtcclxuXHRcdFx0aWYodGhpcy5jaGlsZE5vZGVzLmxlbmd0aCA+IDApe1xyXG5cdFx0XHRcdHRoaXMuY2hpbGROb2Rlc1swXS5pbm5lckhUTUwgPSBzdGF0ZSA/ICdmYXZvcml0ZScgOidmYXZvcml0ZV9ib3JkZXInO1xyXG5cdFx0XHR9XHJcblx0XHR9ZWxzZXtcclxuXHRcdFx0c2VuZGVyLmlubmVySFRNTCA9IHN0YXRlID8gJ2Zhdm9yaXRlJyA6J2Zhdm9yaXRlX2JvcmRlcic7XHJcblxyXG5cdFx0fVxyXG5cdH1cclxufVxyXG4vKmVzbGludCBuby1jb25zb2xlOiAwKi9cclxuLyplc2xpbnQgbm8tdW51c2VkLXZhcnM6IDAqL1xyXG4vKmVzbGludCBuby11bmRlZjogMCovXHJcblxyXG5sZXQgcmVzdGF1cmFudDtcclxuXHJcbi8qKlxyXG4gKiBJbml0aWFsaXplIEdvb2dsZSBtYXAsIGNhbGxlZCBmcm9tIEhUTUwuXHJcbiAqL1xyXG53aW5kb3cuaW5pdE1hcERldGFpbHMgPSAoKSA9PiB7XHJcblx0ZmV0Y2hSZXN0YXVyYW50RnJvbVVSTCgoZXJyb3IsIHJlc3RhdXJhbnQpID0+IHtcclxuXHRcdGlmIChlcnJvcikgeyAvLyBHb3QgYW4gZXJyb3IhXHJcblx0XHRcdGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0c2VsZi5tYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAnKSwge1xyXG5cdFx0XHRcdHpvb206IDE2LFxyXG5cdFx0XHRcdGNlbnRlcjogcmVzdGF1cmFudC5sYXRsbmcsXHJcblx0XHRcdFx0c2Nyb2xsd2hlZWw6IGZhbHNlXHJcblx0XHRcdH0pO1xyXG5cdFx0XHRmaWxsQnJlYWRjcnVtYigpO1xyXG5cdFx0XHREQkhlbHBlci5tYXBNYXJrZXJGb3JSZXN0YXVyYW50KHNlbGYucmVzdGF1cmFudCwgc2VsZi5tYXApO1xyXG5cdFx0fVxyXG5cdH0pO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIEdldCBjdXJyZW50IHJlc3RhdXJhbnQgZnJvbSBwYWdlIFVSTC5cclxuICovXHJcbmZ1bmN0aW9uIGZldGNoUmVzdGF1cmFudEZyb21VUkwoY2FsbGJhY2spe1xyXG5cdGlmIChzZWxmLnJlc3RhdXJhbnQpIHsgLy8gcmVzdGF1cmFudCBhbHJlYWR5IGZldGNoZWQhXHJcblx0XHRjYWxsYmFjayhudWxsLCBzZWxmLnJlc3RhdXJhbnQpO1xyXG5cdFx0cmV0dXJuO1xyXG5cdH1cclxuXHRjb25zdCBpZCA9IGdldFBhcmFtZXRlckJ5TmFtZSgnaWQnKTtcclxuXHRpZiAoIWlkKSB7IC8vIG5vIGlkIGZvdW5kIGluIFVSTFxyXG5cdFx0Y2FsbGJhY2soJ05vIHJlc3RhdXJhbnQgaWQgaW4gVVJMJywgbnVsbCk7XHJcblx0fSBlbHNlIHtcclxuXHRcdERCSGVscGVyLmZldGNoUmVzdGF1cmFudEJ5SWQoaWQsIChlcnJvciwgcmVzdGF1cmFudCkgPT4ge1xyXG5cdFx0XHRzZWxmLnJlc3RhdXJhbnQgPSByZXN0YXVyYW50O1xyXG5cdFx0XHRpZiAoIXJlc3RhdXJhbnQpIHtcclxuXHRcdFx0XHRjb25zb2xlLmVycm9yKGVycm9yKTtcclxuXHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdH1cclxuXHRcdFx0ZmlsbFJlc3RhdXJhbnRIVE1MKCk7XHJcblx0XHRcdGNhbGxiYWNrKG51bGwsIHJlc3RhdXJhbnQpO1xyXG5cdFx0fSk7XHJcblx0fVxyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlIHJlc3RhdXJhbnQgSFRNTCBhbmQgYWRkIGl0IHRvIHRoZSB3ZWJwYWdlXHJcbiAqL1xyXG5mdW5jdGlvbiBmaWxsUmVzdGF1cmFudEhUTUwocmVzdGF1cmFudCA9IHNlbGYucmVzdGF1cmFudCl7XHJcbiAgXHJcblx0Y29uc3QgbmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LW5hbWUnKTtcclxuXHRuYW1lLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmFtZTtcclxuICBcclxuXHRjb25zdCBhZGRyZXNzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtYWRkcmVzcycpO1xyXG5cdGFkZHJlc3MuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5hZGRyZXNzO1xyXG4gIFxyXG5cdGNvbnN0IGltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtaW1nJyk7XHJcblx0aW1hZ2UuY2xhc3NOYW1lID0gJ3Jlc3RhdXJhbnQtaW1nJztcclxuXHRsZXQgcGljVXJsU21hbGwgPSBEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkuY29uY2F0KCctc21hbGwuanBnJyk7XHJcblx0Ly9pbWFnZS5zcmMgPSBwaWNVcmxTbWFsbDtcclxuXHRpbWFnZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3JjJywgcGljVXJsU21hbGwpO1xyXG5cdGltYWdlLmFsdCA9ICdJbWFnZSBvZiBcIicgKyByZXN0YXVyYW50Lm5hbWUgKyAnXCIgcmVzdGF1cmFudC4nO1xyXG4gIFxyXG5cdGNvbnN0IHNyY1NtYWxsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NvdXJjZS1zbWFsbCcpO1xyXG5cdGxldCBwaWNVcmxNZWRpdW0gPSBwaWNVcmxTbWFsbC5yZXBsYWNlKCdzbWFsbCcsJ21lZGl1bScpO1xyXG5cdHNyY1NtYWxsLnNyY3NldCA9IHBpY1VybFNtYWxsICsgJyAxeCwgJyArIHBpY1VybE1lZGl1bSArICcgMngnO1xyXG4gIFxyXG5cdGNvbnN0IHNyY0xhcmdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NvdXJjZS1sYXJnZScpO1xyXG5cdGxldCBwaWNVcmxMYXJnZSA9IHBpY1VybFNtYWxsLnJlcGxhY2UoJ3NtYWxsJywnbGFyZ2UnKTtcclxuXHRzcmNMYXJnZS5zcmNzZXQgPSBwaWNVcmxNZWRpdW0gKyAnIDF4LCAnICsgcGljVXJsTGFyZ2UgKyAnIDJ4JztcclxuXHJcblx0Ly9jb25zdCBwaWN0dXJlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtcGljdHVyZScpO1xyXG5cclxuXHRjb25zdCBjdWlzaW5lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtY3Vpc2luZScpO1xyXG5cdGN1aXNpbmUuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5jdWlzaW5lX3R5cGU7XHJcblxyXG5cdC8vIGZpbGwgb3BlcmF0aW5nIGhvdXJzXHJcblx0aWYgKHJlc3RhdXJhbnQub3BlcmF0aW5nX2hvdXJzKSB7XHJcblx0XHRmaWxsUmVzdGF1cmFudEhvdXJzSFRNTCgpO1xyXG5cdH1cclxuXHQvLyBmaWxsIHJldmlld3NcclxuXHRmaWxsUmV2aWV3c0hUTUwoKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSByZXN0YXVyYW50IG9wZXJhdGluZyBob3VycyBIVE1MIHRhYmxlIGFuZCBhZGQgaXQgdG8gdGhlIHdlYnBhZ2UuXHJcbiAqL1xyXG5mdW5jdGlvbiBmaWxsUmVzdGF1cmFudEhvdXJzSFRNTCAob3BlcmF0aW5nSG91cnMgPSBzZWxmLnJlc3RhdXJhbnQub3BlcmF0aW5nX2hvdXJzKXtcclxuXHRjb25zdCBob3VycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LWhvdXJzJyk7XHJcblx0Zm9yIChsZXQga2V5IGluIG9wZXJhdGluZ0hvdXJzKSB7XHJcblx0XHRjb25zdCByb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpO1xyXG5cclxuXHRcdGNvbnN0IGRheSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RkJyk7XHJcblx0XHRkYXkuaW5uZXJIVE1MID0ga2V5O1xyXG5cdFx0ZGF5LmNsYXNzTmFtZSA9ICd0YWJsZS1kYXknO1xyXG5cdFx0cm93LmFwcGVuZENoaWxkKGRheSk7XHJcblxyXG5cdFx0Y29uc3QgdGltZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RkJyk7XHJcblx0XHR0aW1lLmlubmVySFRNTCA9IG9wZXJhdGluZ0hvdXJzW2tleV07XHJcblx0XHR0aW1lLmNsYXNzTmFtZSA9ICd0YWJsZS10aW1lJztcclxuXHRcdHJvdy5hcHBlbmRDaGlsZCh0aW1lKTtcclxuXHJcblx0XHRob3Vycy5hcHBlbmRDaGlsZChyb3cpO1xyXG5cdH1cclxufVxyXG5cclxuLyoqXHJcbiAqIHN1Ym1pdFJldmlldyAtIHN1Ym1pdHMgYSByZXZpZXcgdG8gdGhlIGRhdGFiYXNlXHJcbiAqXHJcbiAqL1xyXG5mdW5jdGlvbiBzdWJtaXRSZXZpZXcoZSkge1xyXG5cdGlmICghZSlcclxuXHRcdGUgPSB3aW5kb3cuZXZlbnQ7XHJcblx0Y29uc3Qgc2VuZGVyID0gZS5zcmNFbGVtZW50IHx8IGUudGFyZ2V0O1xyXG5cdGNvbnN0IGlkID0gc2VuZGVyLmdldEF0dHJpYnV0ZSgncmVzdGF1cmFudC1pZCcpO1xyXG5cdGNvbnN0IG5hbWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmV2aWV3LW5hbWUnKS52YWx1ZTtcclxuXHRjb25zdCBjb21tZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jldmlldy10ZXh0JykudmFsdWU7XHJcblx0Y29uc3QgcmF0aW5nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jldmlldy1yYXRpbmcnKS52YWx1ZTtcclxuXHRpZihuYW1lICYmIGNvbW1lbnQpe1xyXG5cdFx0Y29uc3QgZGF0YSA9IHtcclxuXHRcdFx0J3Jlc3RhdXJhbnRfaWQnOiBpZCxcclxuXHRcdFx0J25hbWUnOiBuYW1lLFxyXG5cdFx0XHQncmF0aW5nJzogcmF0aW5nLFxyXG5cdFx0XHQnY29tbWVudHMnOiBjb21tZW50LFxyXG5cdFx0XHQnY3JlYXRlZEF0JzogKG5ldyBEYXRlKCkpLmdldFRpbWUoKVxyXG5cdFx0fTtcclxuXHRcdGNvbnN0IHVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jldmlld3MtbGlzdCcpO1xyXG5cdFx0dWwuYXBwZW5kQ2hpbGQoY3JlYXRlUmV2aWV3SFRNTChkYXRhKSk7XHJcblx0XHRjb25zdCByZXZpZXcgPSBEQkhlbHBlci5hZGRSZXN0YXVyYW50UmV2aWV3KGRhdGEpO1xyXG5cdH1cclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSBhbGwgcmV2aWV3cyBIVE1MIGFuZCBhZGQgdGhlbSB0byB0aGUgd2VicGFnZS5cclxuICovXHJcbmZ1bmN0aW9uIGZpbGxSZXZpZXdzSFRNTChyZXZpZXdzID0gc2VsZi5yZXN0YXVyYW50LnJldmlld3MsIGlkID0gc2VsZi5yZXN0YXVyYW50LmlkKSB7XHJcblx0Y29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jldmlld3MtY29udGFpbmVyJyk7XHJcblx0aWYgKCFyZXZpZXdzKSB7XHJcblx0XHRjb25zdCBub1Jldmlld3MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcblx0XHRub1Jldmlld3MuaW5uZXJIVE1MID0gJ05vIHJldmlld3MgeWV0ISc7XHJcblx0XHRjb250YWluZXIuYXBwZW5kQ2hpbGQobm9SZXZpZXdzKTtcclxuXHRcdHJldHVybjtcclxuXHR9XHJcblx0Y29uc3QgYnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FkZC1jb21tZW50Jyk7XHJcblx0YnV0dG9uLnNldEF0dHJpYnV0ZSgncmVzdGF1cmFudC1pZCcsIGlkKTtcclxuXHRidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzdWJtaXRSZXZpZXcsIGZhbHNlKTtcclxuXHRjb25zdCB1bCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXZpZXdzLWxpc3QnKTtcclxuXHRyZXZpZXdzLmZvckVhY2gocmV2aWV3ID0+IHtcclxuXHRcdHVsLmFwcGVuZENoaWxkKGNyZWF0ZVJldmlld0hUTUwocmV2aWV3KSk7XHJcblx0fSk7XHJcblx0Y29udGFpbmVyLmFwcGVuZENoaWxkKHVsKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSByZXZpZXcgSFRNTCBhbmQgYWRkIGl0IHRvIHRoZSB3ZWJwYWdlLlxyXG4gKi9cclxuZnVuY3Rpb24gY3JlYXRlUmV2aWV3SFRNTChyZXZpZXcpe1xyXG5cdGNvbnN0IGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcclxuXHRjb25zdCBuYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG5cdG5hbWUuaW5uZXJIVE1MID0gcmV2aWV3Lm5hbWU7XHJcblx0bGkuYXBwZW5kQ2hpbGQobmFtZSk7XHJcblxyXG5cdGNvbnN0IGRhdGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcblx0Ly9jb25zdCBjcmVhdGVkRGF0ZSA9IG5ldyBEYXRlKHJldmlldy5jcmVhdGVkQXQpO1xyXG5cdGRhdGUuaW5uZXJIVE1MID0gbmV3IERhdGUocmV2aWV3LmNyZWF0ZWRBdCkudG9Mb2NhbGVEYXRlU3RyaW5nKCk7XHJcblx0bGkuYXBwZW5kQ2hpbGQoZGF0ZSk7XHJcblxyXG5cdGNvbnN0IHJhdGluZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuXHRyYXRpbmcuaW5uZXJIVE1MID0gYFJhdGluZzogJHtyZXZpZXcucmF0aW5nfWA7XHJcblx0bGkuYXBwZW5kQ2hpbGQocmF0aW5nKTtcclxuXHJcblx0Y29uc3QgY29tbWVudHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcblx0Y29tbWVudHMuY2xhc3NOYW1lID0gJ3Jldmlldy1jb21tZW50cyc7XHJcblx0Y29tbWVudHMuaW5uZXJIVE1MID0gcmV2aWV3LmNvbW1lbnRzO1xyXG5cdGxpLmFwcGVuZENoaWxkKGNvbW1lbnRzKTtcclxuXHJcblx0cmV0dXJuIGxpO1xyXG59XHJcblxyXG4vKipcclxuICogQWRkIHJlc3RhdXJhbnQgbmFtZSB0byB0aGUgYnJlYWRjcnVtYiBuYXZpZ2F0aW9uIG1lbnVcclxuICovXHJcbmZ1bmN0aW9uIGZpbGxCcmVhZGNydW1iKHJlc3RhdXJhbnQ9c2VsZi5yZXN0YXVyYW50KSB7XHJcblx0Y29uc3QgYnJlYWRjcnVtYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdicmVhZGNydW1iJyk7XHJcblx0Y29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpO1xyXG5cdGxpLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmFtZTtcclxuXHRicmVhZGNydW1iLmFwcGVuZENoaWxkKGxpKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEdldCBhIHBhcmFtZXRlciBieSBuYW1lIGZyb20gcGFnZSBVUkwuXHJcbiAqL1xyXG5mdW5jdGlvbiBnZXRQYXJhbWV0ZXJCeU5hbWUobmFtZSwgdXJsKXtcclxuXHRpZiAoIXVybClcclxuXHRcdHVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmO1xyXG5cdG5hbWUgPSBuYW1lLnJlcGxhY2UoL1tbXFxdXS9nLCAnXFxcXCQmJyk7XHJcblx0Y29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKGBbPyZdJHtuYW1lfSg9KFteJiNdKil8JnwjfCQpYCksXHJcblx0XHRyZXN1bHRzID0gcmVnZXguZXhlYyh1cmwpO1xyXG5cdGlmICghcmVzdWx0cylcclxuXHRcdHJldHVybiBudWxsO1xyXG5cdGlmICghcmVzdWx0c1syXSlcclxuXHRcdHJldHVybiAnJztcclxuXHRyZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHJlc3VsdHNbMl0ucmVwbGFjZSgvXFwrL2csICcgJykpO1xyXG59XHJcblxyXG4vKmVzbGludCBuby1jb25zb2xlOiAwKi9cclxuLyplc2xpbnQgbm8tdW5kZWY6IDAqL1xyXG5pZiAoJ3NlcnZpY2VXb3JrZXInIGluIG5hdmlnYXRvcikge1xyXG5cdHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4ge1xyXG5cdFx0bmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIucmVnaXN0ZXIoJ3N3LmpzJykudGhlbigoKSA9PiB7XHJcblx0XHRcdGNvbnNvbGUubG9nKCdTZXJ2aWNlIFdvcmtlciBSZWdpc3RlcmQnKTtcclxuXHRcdH0pLmNhdGNoKChlKSA9PiB7XHJcblx0XHRcdGNvbnNvbGUuZXJyb3IoZSk7XHRcclxuXHRcdH0pO1xyXG5cdH0pO1xyXG59XHJcblxyXG5cclxud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ29ubGluZScsIERCSGVscGVyLnNlbmRRdWV1ZWRSZXF1ZXN0cywgZmFsc2UpOyJdLCJmaWxlIjoiYWxsLmpzIn0=
